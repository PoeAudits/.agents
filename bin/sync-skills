#!/bin/bash
# Sync skills from ~/.agents/skills to ~/.config/opencode/skills

SOURCE_DIR="$HOME/.agents/skills"
TARGET_DIR="$HOME/.config/opencode/skills"

# Ensure target directory exists
mkdir -p "$TARGET_DIR"

added=()
removed=()
existing=()

# Create symlinks for new skills
for skill in "$SOURCE_DIR"/*/; do
    name=$(basename "$skill")
    if [ ! -e "$TARGET_DIR/$name" ]; then
        ln -s "$SOURCE_DIR/$name" "$TARGET_DIR/$name"
        added+=("$name")
    else
        existing+=("$name")
    fi
done

# Remove broken symlinks
for link in "$TARGET_DIR"/*; do
    if [ -L "$link" ] && [ ! -e "$link" ]; then
        rm "$link"
        removed+=("$(basename "$link")")
    fi
done

# Helper to get skill count for categories
get_skill_info() {
    local name=$1
    local subskills=$(find "$SOURCE_DIR/$name" -mindepth 2 -maxdepth 2 -name "SKILL.md" 2>/dev/null | wc -l)
    if [ "$subskills" -gt 0 ]; then
        [ "$subskills" -eq 1 ] && echo "$name/ ($subskills skill)" || echo "$name/ ($subskills skills)"
    else
        echo "$name/"
    fi
}

# Show new skills
if [ ${#added[@]} -gt 0 ]; then
    echo "=== New (${#added[@]}) ==="
    for name in "${added[@]}"; do
        echo "+ $(get_skill_info "$name")"
    done
    echo ""
fi

# Show removed skills
if [ ${#removed[@]} -gt 0 ]; then
    echo "=== Removed (${#removed[@]}) ==="
    for name in "${removed[@]}"; do
        echo "- $name/"
    done
    echo ""
fi

# Show existing skills
if [ ${#existing[@]} -gt 0 ]; then
    echo "=== Existing (${#existing[@]}) ==="
    for name in "${existing[@]}"; do
        echo "  $(get_skill_info "$name")"
    done
    echo ""
fi

# Summary
total=$((${#added[@]} + ${#existing[@]}))
echo "=== Summary ==="
echo "Total: $total skills synced"
[ ${#added[@]} -gt 0 ] && echo "New: ${#added[@]}"
[ ${#removed[@]} -gt 0 ] && echo "Removed: ${#removed[@]}"
[ ${#added[@]} -eq 0 ] && [ ${#removed[@]} -eq 0 ] && echo "No changes"
